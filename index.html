<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3 Map with Image</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        circle {
            fill: red;
            stroke: black;
            stroke-width: 2;
        }

        .tooltip {
            background-color: yellow;
            padding: 5px;
            border-radius: 5px;
            font-family: sans-serif;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <svg width="800" height="600" id="map-svg"></svg>
    <script src="https://unpkg.com/d3-simple-slider"></script>
    <div id="slider-time"></div>

    <script>
        const svg = d3.select("#map-svg");
        const width = 800;
        const height = 600;

        svg.append("image")
            .attr("href", "Waterways.jpg")
            .attr("width", width)
            .attr("height", height);

        const fixedLocations = [
            { name: "Boonsri", x: 428, y: 135 },
            { name: "Kohsoom", x: 550, y: 204 },
            { name: "Busarakhan", x: 548, y: 265 },
            { name: "Chai", x: 475, y: 300 },
            { name: "Kannika", x: 500, y: 436 },
            { name: "Achara", x: 357, y: 220 },
            { name: "Somchair", x: 305, y: 290 },
            { name: "Sakda", x: 428, y: 528 },
            { name: "Tansanee", x: 305, y: 420 },
            { name: "Decha", x: 200, y: 365 }
        ];

        // Function to update circles based on data
        // Function to update circles based on data
        function updateCircles(data) {
            // Select existing circles
            const circles = svg.selectAll("circle")
                .data(data);

            // Update existing circles
            circles
                .attr("r", d => calculateRadius(d.methylosmolineSum));

            // Add new circles for new data points
            circles.enter()
                .append("circle")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("r", d => calculateRadius(d.methylosmolineSum))
                .on("mouseover", function (event, d) {
                    const tooltip = svg.append("g")
                        .attr("class", "tooltip");

                    tooltip.append("rect")
                        .attr("x", d.x + 10)
                        .attr("y", d.y - 20)
                        .attr("width", 80)
                        .attr("height", 30)
                        .attr("fill", "yellow");

                    tooltip.append("text")
                        .attr("x", d.x + 20)
                        .attr("y", d.y - 5)
                        .text(`${d.name}: Methylosmoline Sum - ${d.methylosmolineSum}`)
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "12px")
                        .attr("font-weight", "bold");
                })
                .on("mouseout", function () {
                    svg.selectAll(".tooltip").remove();
                });

            // Remove extra circles if any
            circles.exit().remove();
        }

        // Calculate the radius based on the Methylosmoline sum
        function calculateRadius(methylosmolineSum) {
            // Adjust the scaling factor to make the circles bigger
            const scaleFactor = .9;
            return Math.sqrt(methylosmolineSum) * scaleFactor;
        }

        const csvFileName = "./Cleaned-Boonsong-Lekagul-waterways-readings.csv";

        // Load data from CSV file
        d3.csv(csvFileName).then(function (data) {
            // Initial date from the slider
            const methylosmolineDates = data
                .filter(d => d.measure === "Methylosmoline")
                .map(d => new Date(d['sample date']));
            let currentDate = new Date(d3.min(methylosmolineDates));


            // Function to filter data based on the selected date
            function filterDataByDate(date) {
                return fixedLocations.map(location => {
                    const correspondingData = data.filter(d => d.location === location.name && new Date(d['sample date']) <= date && d.measure === "Methylosmoline");
                    const methylosmolineSum = correspondingData.reduce((sum, d) => sum + parseFloat(d.value), 0);
                    return {
                        ...location,
                        methylosmolineSum
                    };
                });
            }

            // Update circles based on the Methylosmoline data for the initial date
            updateCircles(filterDataByDate(currentDate));

            // Slider configuration


            const sliderTime = d3
                .sliderBottom()
                .min(d3.min(methylosmolineDates))
                .max(d3.max(methylosmolineDates))
                .width(500)
                .tickFormat(d3.timeFormat('%b %Y'))
                .ticks(10)
                .default(currentDate)
                .on('onchange', val => {
                    currentDate = new Date(val);
                    currentDate.setDate(1); // Set the day to 1
                    console.log(currentDate)
                    updateCircles(filterDataByDate(currentDate));

                });

            const gTime = d3
                .select('div#slider-time')
                .append('svg')
                .attr('width', 600)
                .attr('height', 100)
                .append('g')
                .attr('transform', 'translate(30,30)');

            gTime.call(sliderTime);
        });


        // TODO slider creation, animation, and data filtering. 
    </script>

</body>

</html>